name: DAINS Health Check

on:
  schedule:
    # Run at 5pm Dublin time (before next morning's DAINS)
    # Winter (GMT): 17:00 UTC = 5pm Dublin
    # Summer (IST): 16:00 UTC = 5pm Dublin
    - cron: '0 16 * * *'
    - cron: '0 17 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

    steps:
      - name: Validate Anthropic API Key
        id: validate
        run: |
          echo "Validating Anthropic API key..."

          # Make minimal API call to validate key
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 1,
              "messages": [{"role": "user", "content": "hi"}]
            }')

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=valid" >> $GITHUB_OUTPUT
            echo "‚úÖ Anthropic API key is valid"
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "status=invalid" >> $GITHUB_OUTPUT
            echo "error=Authentication failed - API key is invalid or expired" >> $GITHUB_OUTPUT
            echo "‚ùå Anthropic API key is INVALID"
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "status=invalid" >> $GITHUB_OUTPUT
            echo "error=Permission denied - API key may be disabled or rate limited" >> $GITHUB_OUTPUT
            echo "‚ùå Anthropic API key has permission issues"
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "error=Unexpected response: HTTP $HTTP_CODE" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Unexpected response from Anthropic API"
          fi

      - name: Send alert if API key is invalid
        if: steps.validate.outputs.status != 'valid'
        run: |
          echo "üö® Sending alert - Anthropic API key problem detected!"

          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${RESEND_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"DAINS Alert <alerts@victordelrosal.com>\",
              \"to\": \"${ALERT_EMAIL}\",
              \"subject\": \"‚ö†Ô∏è DAINS Health Check: Anthropic API Key Problem\",
              \"html\": \"<h1>Anthropic API Key Problem Detected</h1><p>The daily health check found an issue with the Anthropic API key. <strong>Tomorrow's DAINS will fail</strong> unless you fix this.</p><p><strong>Error:</strong> ${{ steps.validate.outputs.error }}</p><p><strong>Action required:</strong></p><ol><li>Go to <a href='https://console.anthropic.com/settings/keys'>Anthropic Console</a></li><li>Generate a new API key</li><li>Update the GitHub secret: <a href='https://github.com/${{ github.repository }}/settings/secrets/actions'>Repository Secrets</a></li></ol><p><strong>Workflow run:</strong> <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View logs</a></p>\"
            }"

          echo "Alert sent!"
          exit 1  # Fail the workflow to make it visible

      - name: Health check passed
        if: steps.validate.outputs.status == 'valid'
        run: |
          echo "============================================"
          echo "DAINS Health Check: ALL SYSTEMS GO"
          echo "Anthropic API key is valid and working"
          echo "Tomorrow's DAINS should run successfully"
          echo "============================================"
