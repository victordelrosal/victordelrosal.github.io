name: Update GitHub Contributions

on:
  schedule:
    # Run every Sunday at 6am UTC
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-contributions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Contributions
        env:
          GH_TOKEN: ${{ secrets.GH_CONTRIBUTION_TOKEN }}
        run: |
          # Validate token exists
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::GH_CONTRIBUTION_TOKEN secret is not set. Create a PAT with read:user scope and add it as a repo secret."
            exit 1
          fi

          # Fetch contribution data via GitHub GraphQL API
          HTTP_STATUS=$(curl -s -o /tmp/github-response.json -w "%{http_code}" \
            -H "Authorization: bearer $GH_TOKEN" \
            -X POST \
            -d '{"query":"query { user(login: \"victordelrosal\") { contributionsCollection { contributionCalendar { totalContributions weeks { contributionDays { contributionCount date contributionLevel } } } } } }"}' \
            https://api.github.com/graphql)

          echo "API response status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::GitHub GraphQL API returned HTTP $HTTP_STATUS. Token may be expired or have insufficient scopes."
            cat /tmp/github-response.json
            exit 1
          fi

          # Parse and transform the data
          cat > /tmp/parse.js << 'SCRIPT'
          const fs = require('fs');
          const raw = fs.readFileSync('/tmp/github-response.json', 'utf8');
          const response = JSON.parse(raw);

          if (response.errors) {
            console.error('GraphQL errors:', JSON.stringify(response.errors, null, 2));
            process.exit(1);
          }

          if (!response.data || !response.data.user) {
            console.error('Unexpected response structure:', raw.substring(0, 500));
            process.exit(1);
          }

          const calendar = response.data.user.contributionsCollection.contributionCalendar;
          const contributions = [];

          const levelMap = {
            'NONE': 0,
            'FIRST_QUARTILE': 1,
            'SECOND_QUARTILE': 2,
            'THIRD_QUARTILE': 3,
            'FOURTH_QUARTILE': 4
          };

          calendar.weeks.forEach(week => {
            week.contributionDays.forEach(day => {
              contributions.push({
                date: day.date,
                count: day.contributionCount,
                level: levelMap[day.contributionLevel] || 0
              });
            });
          });

          const output = {
            total: calendar.totalContributions,
            lastUpdated: new Date().toISOString(),
            contributions: contributions
          };

          fs.writeFileSync('data/github-contributions.json', JSON.stringify(output, null, 2));
          console.log(`Updated: ${calendar.totalContributions} total contributions, ${contributions.length} days`);
          SCRIPT

          mkdir -p data
          node /tmp/parse.js

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/github-contributions.json
          git diff --staged --quiet || git commit -m "chore: update GitHub contributions data"
          git push
