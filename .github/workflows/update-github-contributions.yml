name: Update GitHub Contributions

on:
  schedule:
    # Run every Sunday at 6am UTC
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-contributions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Contributions
        env:
          GH_TOKEN: ${{ secrets.GH_CONTRIBUTION_TOKEN }}
        run: |
          # Fetch contribution data via GitHub GraphQL API
          curl -s -H "Authorization: bearer $GH_TOKEN" \
            -X POST \
            -d '{"query":"query { user(login: \"victordelrosal\") { contributionsCollection { contributionCalendar { totalContributions weeks { contributionDays { contributionCount date contributionLevel } } } } } }"}' \
            https://api.github.com/graphql > /tmp/github-response.json

          # Parse and transform the data
          cat > /tmp/parse.js << 'SCRIPT'
          const fs = require('fs');
          const response = JSON.parse(fs.readFileSync('/tmp/github-response.json', 'utf8'));

          if (response.errors) {
            console.error('GraphQL errors:', response.errors);
            process.exit(1);
          }

          const calendar = response.data.user.contributionsCollection.contributionCalendar;
          const contributions = [];

          // Map contribution levels to numeric values
          const levelMap = {
            'NONE': 0,
            'FIRST_QUARTILE': 1,
            'SECOND_QUARTILE': 2,
            'THIRD_QUARTILE': 3,
            'FOURTH_QUARTILE': 4
          };

          calendar.weeks.forEach(week => {
            week.contributionDays.forEach(day => {
              contributions.push({
                date: day.date,
                count: day.contributionCount,
                level: levelMap[day.contributionLevel] || 0
              });
            });
          });

          const output = {
            total: calendar.totalContributions,
            lastUpdated: new Date().toISOString(),
            contributions: contributions
          };

          fs.writeFileSync('data/github-contributions.json', JSON.stringify(output, null, 2));
          console.log(`Updated: ${calendar.totalContributions} total contributions`);
          SCRIPT

          mkdir -p data
          node /tmp/parse.js

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/github-contributions.json
          git diff --staged --quiet || git commit -m "chore: update GitHub contributions data"
          git push
